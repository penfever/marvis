

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>marvis.data.dataset &mdash; MARVIS 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=251ceabf" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MARVIS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/quick-start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/configuration.html">Configuration Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/vision/index.html">Vision Classification Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/audio/index.html">Audio Classification Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/tabular/index.html">Tabular Data Classification Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/api-models/index.html">API Models Integration Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/basic-classification.html">Basic Classification Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/multi-modal-pipeline.html">Multi-Modal Pipeline Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/custom-datasets.html">Custom Datasets Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/marvis.models.html">marvis.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/marvis.data.html">marvis.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/marvis.utils.html">marvis.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/marvis.viz.html">marvis.viz</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Technical Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../technical-guides/resource-management.html">Resource Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../technical-guides/caching-system.html">Caching System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../technical-guides/evaluation-frameworks.html">Evaluation Frameworks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Troubleshooting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to MARVIS</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MARVIS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">marvis.data.dataset</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for marvis.data.dataset</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Dataset loading and preparation utilities.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.embeddings</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_tabpfn_embeddings_for_prefix</span>

<span class="c1"># Utility function to silence specific warnings</span>
<div class="viewcode-block" id="silence_pandas_warning">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.silence_pandas_warning">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">silence_pandas_warning</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a function with pandas warnings temporarily silenced.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;.*factorize.*&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Import the new resource management system</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.resource_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_resource_manager</span><span class="p">,</span> <span class="n">DatasetMetadata</span>

<span class="c1"># Global cache to store dataset IDs that have failed to load (legacy)</span>
<span class="n">_FAILED_DATASET_CACHE</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_load_failed_dataset_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the cache of failed dataset IDs using the new resource manager.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_FAILED_DATASET_CACHE</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">get_resource_manager</span><span class="p">()</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">cache_manager</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;failed_datasets&#39;</span><span class="p">)</span>
        <span class="n">cached_data</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">cache_manager</span><span class="o">.</span><span class="n">load_from_cache</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cached_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cached_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_FAILED_DATASET_CACHE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">did</span><span class="p">)</span> <span class="k">for</span> <span class="n">did</span> <span class="ow">in</span> <span class="n">cached_data</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed dataset IDs from managed cache&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_FAILED_DATASET_CACHE</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load from managed cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Fallback to legacy cache file</span>
    <span class="n">legacy_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.marvis_failed_datasets.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">legacy_cache_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">legacy_cache_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">cache_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">_FAILED_DATASET_CACHE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">did</span><span class="p">)</span> <span class="k">for</span> <span class="n">did</span> <span class="ow">in</span> <span class="n">cache_data</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed dataset IDs from legacy cache&quot;</span><span class="p">)</span>
                    <span class="c1"># Migrate to new cache</span>
                    <span class="n">_save_failed_dataset_cache</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">_FAILED_DATASET_CACHE</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading legacy failed dataset cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># If we couldn&#39;t load any cache</span>
    <span class="n">_FAILED_DATASET_CACHE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_FAILED_DATASET_CACHE</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_save_failed_dataset_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the cache of failed dataset IDs using the new resource manager.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">get_resource_manager</span><span class="p">()</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">cache_manager</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;failed_datasets&#39;</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">cache_manager</span><span class="o">.</span><span class="n">save_to_cache</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">),</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed dataset IDs to managed cache&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to legacy file</span>
            <span class="n">legacy_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.marvis_failed_datasets.json&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">legacy_cache_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed dataset IDs to legacy cache&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving failed dataset cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Initialize the cache</span>
<span class="n">_load_failed_dataset_cache</span><span class="p">()</span>

<div class="viewcode-block" id="list_available_datasets">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.list_available_datasets">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_available_datasets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary of predefined OpenML dataset names and their IDs.</span>
<span class="sd">    These datasets are known to work well with MARVIS.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping dataset names to their OpenML IDs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;airlines&#39;</span><span class="p">:</span> <span class="mi">1169</span><span class="p">,</span>        <span class="c1"># Binary classification, 539k samples, 7 features</span>
        <span class="s1">&#39;albert&#39;</span><span class="p">:</span> <span class="mi">189356</span><span class="p">,</span>        <span class="c1"># Multi-class, 425k samples, 79 features</span>
        <span class="s1">&#39;volkert&#39;</span><span class="p">:</span> <span class="mi">41166</span><span class="p">,</span>        <span class="c1"># Multi-class, 58k samples, 181 features</span>
        <span class="s1">&#39;higgs&#39;</span><span class="p">:</span> <span class="mi">44129</span><span class="p">,</span>          <span class="c1"># Binary classification, 98k samples, 29 features</span>
        <span class="s1">&#39;har&#39;</span><span class="p">:</span> <span class="mi">1478</span><span class="p">,</span>             <span class="c1"># Multi-class, 10k samples, 562 features</span>
        <span class="s1">&#39;adult&#39;</span><span class="p">:</span> <span class="mi">1590</span><span class="p">,</span>           <span class="c1"># Binary classification, 48k samples, 14 features</span>
        <span class="s1">&#39;bank-marketing&#39;</span><span class="p">:</span> <span class="mi">1461</span><span class="p">,</span>  <span class="c1"># Binary classification, 45k samples, 16 features</span>
        <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">40975</span><span class="p">,</span>            <span class="c1"># Multi-class, 1.7k samples, 21 features</span>
        <span class="s1">&#39;connect-4&#39;</span><span class="p">:</span> <span class="mi">40668</span><span class="p">,</span>      <span class="c1"># Multi-class, 67k samples, 42 features</span>
        <span class="s1">&#39;credit-g&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>          <span class="c1"># Binary classification, 1k samples, 20 features</span>
        <span class="s1">&#39;diabetes&#39;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>          <span class="c1"># Binary classification, 768 samples, 8 features</span>
        <span class="s1">&#39;fashion-mnist&#39;</span><span class="p">:</span> <span class="mi">40996</span><span class="p">,</span>  <span class="c1"># Multi-class, 70k samples, 784 features</span>
        <span class="s1">&#39;Jannis&#39;</span><span class="p">:</span> <span class="mi">168911</span><span class="p">,</span>        <span class="c1"># Multi-class, 83k samples, 54 features</span>
        <span class="s1">&#39;jungle_chess&#39;</span><span class="p">:</span> <span class="mi">167149</span><span class="p">,</span>  <span class="c1"># Multi-class, 44k samples, 6 features</span>
        <span class="s1">&#39;mnist&#39;</span><span class="p">:</span> <span class="mi">554</span><span class="p">,</span>            <span class="c1"># Multi-class, 70k samples, 784 features</span>
        <span class="s1">&#39;nomao&#39;</span><span class="p">:</span> <span class="mi">1486</span><span class="p">,</span>           <span class="c1"># Binary classification, 34k samples, 118 features</span>
        <span class="s1">&#39;phoneme&#39;</span><span class="p">:</span> <span class="mi">1489</span><span class="p">,</span>         <span class="c1"># Binary classification, 5.4k samples, 5 features</span>
        <span class="s1">&#39;Shuttle&#39;</span><span class="p">:</span> <span class="mi">40685</span><span class="p">,</span>        <span class="c1"># Multi-class, 43.5k samples, 9 features</span>
        <span class="s1">&#39;vehicle&#39;</span><span class="p">:</span> <span class="mi">54</span><span class="p">,</span>           <span class="c1"># Multi-class, 846 samples, 18 features</span>
        <span class="s1">&#39;wine-quality-white&#39;</span><span class="p">:</span> <span class="mi">40498</span>  <span class="c1"># Multi-class, 4.9k samples, 11 features</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="get_dataset_info">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.get_dataset_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_dataset_info</span><span class="p">(</span><span class="n">dataset_id_or_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get information about a dataset from OpenML without loading the actual data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dataset_id_or_name: ID or name of the dataset to get info about</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with dataset information including name, ID, feature count,</span>
<span class="sd">        sample count, target feature, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">openml</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;OpenML package is required. Install it with &#39;pip install openml&#39;.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Resolve dataset ID from name if needed</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># If input is already an integer, use it directly</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_id_or_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">dataset_id_or_name</span>
    <span class="c1"># If input is a string that looks like a number, convert to int</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_id_or_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dataset_id_or_name</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset_id_or_name</span><span class="p">)</span>
    <span class="c1"># Check if it&#39;s a known dataset name</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_id_or_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">dataset_ids</span> <span class="o">=</span> <span class="n">list_available_datasets</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dataset_id_or_name</span> <span class="ow">in</span> <span class="n">dataset_ids</span><span class="p">:</span>
            <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">dataset_ids</span><span class="p">[</span><span class="n">dataset_id_or_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to search by name using dataframe format</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">datasets_df</span> <span class="o">=</span> <span class="n">openml</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">dataset_id_or_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="c1"># Get the first match</span>
                    <span class="n">first_match</span> <span class="o">=</span> <span class="n">datasets_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">first_match</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find any dataset matching &#39;</span><span class="si">{</span><span class="n">dataset_id_or_name</span><span class="si">}</span><span class="s2">&#39; on OpenML.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error searching for dataset: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find dataset &#39;</span><span class="si">{</span><span class="n">dataset_id_or_name</span><span class="si">}</span><span class="s2">&#39;. Please provide a valid OpenML dataset ID or name.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Now get the dataset info</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">openml</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
        
        <span class="c1"># Check if dataset loaded properly</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> could not be loaded from OpenML&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has no features information available&quot;</span><span class="p">)</span>
        
        <span class="c1"># Build info dictionary</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="s1">&#39;num_features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;num_samples&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">qualities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NumberOfInstances&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">qualities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NumberOfClasses&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;num_missing_values&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">qualities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NumberOfMissingValues&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">default_target_attribute</span><span class="p">,</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://www.openml.org/d/</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">description</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">description</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s1">&#39;No description available&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1"># Get class distribution if available</span>
        <span class="n">class_distribution</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">qualities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ClassDistribution&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">class_distribution</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
                <span class="c1"># Parse the class distribution string</span>
                <span class="n">distribution</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">class_distribution</span><span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;class_distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distribution</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="k">return</span> <span class="n">info</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting dataset info for ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get dataset info for ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_dataset">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.load_dataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bypass_size_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">preserve_regression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a dataset from OpenML. Can load datasets by name or ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_name: Name or ID of the dataset to load. If using a name, it can be one of the</span>
<span class="sd">                    predefined datasets (use list_available_datasets() to see options)</span>
<span class="sd">                    or any other OpenML dataset name. If using an ID, it should be a string representation</span>
<span class="sd">                    of the OpenML dataset ID (e.g., &#39;1169&#39; for Airlines).</span>
<span class="sd">        bypass_size_check: If True, bypasses the minimum 1000 samples requirement. Default is False.</span>
<span class="sd">        preserve_regression: If True, preserves continuous targets for regression tasks instead of </span>
<span class="sd">                           converting them to classification. Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        X: Features</span>
<span class="sd">        y: Labels</span>
<span class="sd">        categorical_indicator: Boolean list indicating categorical features</span>
<span class="sd">        attribute_names: List of feature names</span>
<span class="sd">        dataset_name: Full name of the dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">openml</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;OpenML package is required to load datasets. Install it with &#39;pip install openml&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Get dataset mappings from the available datasets function</span>
    <span class="n">dataset_ids</span> <span class="o">=</span> <span class="n">list_available_datasets</span><span class="p">()</span>

    <span class="c1"># Check if dataset_name is an ID</span>
    <span class="k">if</span> <span class="n">dataset_name</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading dataset with ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> from OpenML&quot;</span><span class="p">)</span>
    <span class="c1"># Check if it&#39;s a known dataset name</span>
    <span class="k">elif</span> <span class="n">dataset_name</span> <span class="ow">in</span> <span class="n">dataset_ids</span><span class="p">:</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">dataset_ids</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> dataset (ID: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">) from OpenML&quot;</span><span class="p">)</span>
    <span class="c1"># Try to find by name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Search for dataset by name using dataframe format</span>
            <span class="n">datasets_df</span> <span class="o">=</span> <span class="n">openml</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Get the first match</span>
                <span class="n">first_match</span> <span class="o">=</span> <span class="n">datasets_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">first_match</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found dataset matching &#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;: ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">first_match</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find any dataset matching &#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39; on OpenML.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error searching for dataset: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find or load dataset &#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;. Please provide a valid OpenML dataset name or ID.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check if the dataset ID is in the failed dataset cache</span>
    <span class="k">if</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="n">_FAILED_DATASET_CACHE</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has previously failed to load and will be skipped.&quot;</span><span class="p">)</span>
        <span class="n">available_datasets</span> <span class="o">=</span> <span class="n">list_available_datasets</span><span class="p">()</span>
        <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Provide a suggestion for alternative datasets</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Try one of these known working datasets instead:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># Pick 5 random datasets to suggest</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">available_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">did</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use list_available_datasets() to see all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> predefined datasets.&quot;</span>
        
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset with ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> was previously marked as failed. </span><span class="si">{</span><span class="n">suggestion_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="c1"># Pre-check the dataset size if possible to skip small datasets</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataset_info</span> <span class="o">=</span> <span class="n">get_dataset_info</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_samples&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_samples</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bypass_size_check</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has only </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples, which is fewer than the minimum 1000 required, but bypassing size check.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has only </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples, which is fewer than the minimum 1000 required.&quot;</span><span class="p">)</span>
                <span class="c1"># Add to failed dataset cache</span>
                <span class="n">_FAILED_DATASET_CACHE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
                <span class="n">_save_failed_dataset_cache</span><span class="p">()</span>
                <span class="n">available_datasets</span> <span class="o">=</span> <span class="n">list_available_datasets</span><span class="p">()</span>
                <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                
                <span class="c1"># Provide a suggestion for alternative datasets</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Try one of these known working datasets instead:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="c1"># Pick 5 random datasets to suggest</span>
                    <span class="n">suggestions</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">available_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">did</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                        <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use list_available_datasets() to see all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> predefined datasets.&quot;</span>
                
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has only </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples (minimum 1000 required). </span><span class="si">{</span><span class="n">suggestion_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If we can&#39;t check the size beforehand, we&#39;ll check after loading</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not pre-check dataset size: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the dataset by ID</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">openml</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded dataset: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="c1"># First try getting the data without specifying a target</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use dataframe format to handle string values properly</span>
            <span class="n">data_df</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span> <span class="o">=</span> <span class="n">silence_pandas_warning</span><span class="p">(</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">get_data</span><span class="p">,</span>
                <span class="n">dataset_format</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            
            <span class="c1"># Log the default target attribute if it exists</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">default_target_attribute</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset has default target attribute: &#39;</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">default_target_attribute</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                
                <span class="c1"># Check if the default target is actually a column in the dataframe</span>
                <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">default_target_attribute</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">target_column</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">default_target_attribute</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The default target might be specified differently from the actual column name</span>
                    <span class="c1"># Use the last column as a fallback</span>
                    <span class="n">target_column</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default target not found in columns, using last column &#39;</span><span class="si">{</span><span class="n">target_column</span><span class="si">}</span><span class="s2">&#39; as target&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no default target is specified, use the last column</span>
                <span class="n">target_column</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No default target attribute specified, using last column &#39;</span><span class="si">{</span><span class="n">target_column</span><span class="si">}</span><span class="s2">&#39; as target&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract features and target</span>
            <span class="n">y_series</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span>
            
            <span class="c1"># Handle categorical dtypes in target</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y_series</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;category&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_series</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting categorical target to numeric codes&quot;</span><span class="p">)</span>
                <span class="c1"># Convert to category codes which are numeric</span>
                <span class="n">y_series</span> <span class="o">=</span> <span class="n">y_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>
            
            <span class="c1"># Convert target to numpy array</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y_series</span><span class="o">.</span><span class="n">values</span>
            
            <span class="c1"># Fix sparse type issues in the entire dataframe before splitting</span>
            <span class="c1"># This is specifically to handle the Sparse[float32, 0] type</span>
            <span class="n">sparse_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sparse&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">sparse_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">sparse_columns</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> sparse columns in the dataset: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sparse_columns</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_columns</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Process all sparse columns at dataframe level for better efficiency</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sparse_columns</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Try to get dense version directly</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="s1">&#39;sparse&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="p">,</span> <span class="s1">&#39;to_dense&#39;</span><span class="p">):</span>
                            <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Direct conversion for Sparse[float32, 0] type</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Try explicit conversion with pandas API - already imported at top</span>
                                <span class="n">dense_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]],</span> <span class="n">index</span><span class="o">=</span><span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                                <span class="n">data_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dense_series</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Direct sparse conversion failed for column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">. Will try element-wise later.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue pre-converting sparse column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Will try different method during feature processing.&quot;</span><span class="p">)</span>
            
            <span class="c1"># Drop target column and prepare features</span>
            <span class="n">X_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">])</span>
            
            <span class="c1"># Handle problematic column types (categorical, sparse, etc.)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">col_dtype</span> <span class="o">=</span> <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
                <span class="n">col_dtype_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                
                <span class="c1"># Handle categorical columns</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col_dtype</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">col_dtype_str</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting categorical column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; to numeric codes&quot;</span><span class="p">)</span>
                    <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                
                <span class="c1"># Handle sparse columns</span>
                <span class="k">elif</span> <span class="s1">&#39;sparse&#39;</span> <span class="ow">in</span> <span class="n">col_dtype_str</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting sparse column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; to dense&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># First check if it&#39;s a pandas SparseDtype</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="s1">&#39;sparse&#39;</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Try standard pandas sparse conversion with pd.Series to preserve dtype</span>
                                <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err1</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error using sparse.to_dense() for &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">err1</span><span class="si">}</span><span class="s2">. Trying alternative approach.&quot;</span><span class="p">)</span>
                                <span class="c1"># Try converting manually from sparse array</span>
                                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="s1">&#39;_values&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="s1">&#39;_indices&#39;</span><span class="p">):</span>
                                    <span class="c1"># Recreate values for a standard CSR-like format</span>
                                    <span class="n">dense_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
                                    <span class="n">dense_vals</span><span class="p">[</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">_values</span>
                                    <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dense_vals</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Final fallback - try forcing conversion through numpy array</span>
                                    <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Not a pandas sparse type - might be scipy sparse or a custom sparse format</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Try to handle scipy sparse format</span>
                                <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
                                <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                    <span class="c1"># If each element is a separate sparse matrix (unusual case)</span>
                                    <span class="n">dense_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 
                                                 <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
                                    <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dense_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Try general conversion to numpy array</span>
                                    <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
                                <span class="c1"># Last resort - just assign zeros</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to convert sparse column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; using scipy: </span><span class="si">{</span><span class="n">err2</span><span class="si">}</span><span class="s2">. Using zeros.&quot;</span><span class="p">)</span>
                                <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">sparse_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All sparse conversion methods failed for &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sparse_err</span><span class="si">}</span><span class="s2">. Using zeros instead.&quot;</span><span class="p">)</span>
                        <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                
                <span class="c1"># Handle other problematic dtypes</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">col_dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">col_dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; with dtype </span><span class="si">{</span><span class="n">col_dtype</span><span class="si">}</span><span class="s2"> to string and then numeric codes&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Convert to string then use label encoding</span>
                        <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span>
                        <span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
                        <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">conv_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">conv_err</span><span class="si">}</span><span class="s2">. Using zeros instead.&quot;</span><span class="p">)</span>
                        <span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            
            <span class="c1"># Convert to numpy array</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">values</span>
            
            <span class="c1"># Adjust categorical_indicator and attribute_names to match the features (exclude target column)</span>
            <span class="k">if</span> <span class="n">categorical_indicator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">categorical_indicator</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Find the target column index in the original dataframe</span>
                <span class="n">target_index</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
                <span class="c1"># Remove the categorical indicator for the target column</span>
                <span class="n">categorical_indicator</span> <span class="o">=</span> <span class="p">[</span><span class="n">categorical_indicator</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_indicator</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">target_index</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusted categorical_indicator length from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_indicator</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_indicator</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Update attribute_names to exclude target column </span>
            <span class="k">if</span> <span class="n">attribute_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Find the target column index in attribute_names</span>
                <span class="k">if</span> <span class="n">target_column</span> <span class="ow">in</span> <span class="n">attribute_names</span><span class="p">:</span>
                    <span class="n">attribute_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attribute_names</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">target_column</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed target column &#39;</span><span class="si">{</span><span class="n">target_column</span><span class="si">}</span><span class="s2">&#39; from attribute_names&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="c1"># If target is last column, remove last item</span>
                    <span class="n">attribute_names</span> <span class="o">=</span> <span class="n">attribute_names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed last column from attribute_names (assuming it was target)&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting data in dataframe format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Trying alternative approach.&quot;</span><span class="p">)</span>
            
            <span class="c1"># Fall back to array format if dataframe format fails</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span> <span class="o">=</span> <span class="n">silence_pandas_warning</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">get_data</span><span class="p">,</span>
                    <span class="n">dataset_format</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">default_target_attribute</span>
                <span class="p">)</span>
                
                <span class="c1"># Handle special cases for sparse arrays that might be in the data</span>
                <span class="n">sparse_in_array</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="c1"># Check for sparse elements in the array</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sparse_check</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;sparse&#39;</span> <span class="ow">in</span> <span class="n">sparse_check</span><span class="p">:</span>
                            <span class="n">sparse_in_array</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected sparse dtype in numpy array: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># If dtype access fails, check individual elements</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                                    <span class="k">if</span> <span class="s1">&#39;sparse&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                        <span class="n">sparse_in_array</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected sparse elements in numpy array at position [</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="n">sparse_in_array</span><span class="p">:</span>
                                    <span class="k">break</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                
                <span class="c1"># Special handling for sparse arrays</span>
                <span class="k">if</span> <span class="n">sparse_in_array</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting sparse elements in numpy array to dense values&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Create a new array with dense values</span>
                        <span class="n">X_dense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                        
                        <span class="c1"># Loop through elements and convert sparse to dense</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                    <span class="c1"># Handle different sparse formats</span>
                                    <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                                        <span class="n">X_dense</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;sparse&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">sparse</span><span class="p">,</span> <span class="s1">&#39;to_dense&#39;</span><span class="p">):</span>
                                        <span class="n">X_dense</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span>
                                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;_values&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;_indices&#39;</span><span class="p">):</span>
                                        <span class="c1"># Manually extract from COO-like format</span>
                                        <span class="n">X_dense</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># Try direct float conversion</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">X_dense</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">X_dense</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">elem_err</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting element at [</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">elem_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">X_dense</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">X</span> <span class="o">=</span> <span class="n">X_dense</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">conv_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during sparse array conversion: </span><span class="si">{</span><span class="n">conv_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Ensure X is a proper numpy array with numeric types</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting X to numeric array. Original type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dtype&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Try to convert to float array, handling potential issues</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">arr_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting X to float array: </span><span class="si">{</span><span class="n">arr_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># More aggressive approach: element-wise conversion</span>
                        <span class="n">X_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                    <span class="c1"># Handle various types</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)):</span>
                                        <span class="n">X_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">X_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                        <span class="k">except</span><span class="p">:</span>
                                            <span class="n">X_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">X_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">X_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">X</span> <span class="o">=</span> <span class="n">X_new</span>
                
                <span class="c1"># Ensure y is a proper numpy array</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting y to numpy array. Original type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># For classification, try to convert to integers</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Assume classification if less than 100 unique values</span>
                            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span>
                            <span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">y_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error converting y: </span><span class="si">{</span><span class="n">y_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">array_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting data in array format: </span><span class="si">{</span><span class="n">array_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> in either dataframe or array format&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if target is continuous (regression) and convert to classification by binning</span>
        <span class="c1"># Only do this if preserve_regression is False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">preserve_regression</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting continuous target to classification by binning&quot;</span><span class="p">)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">KBinsDiscretizer</span>
            <span class="c1"># Use quantile binning to create balanced classes with safety checks</span>
            <span class="n">n_unique_targets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="c1"># Ensure safe quantile computation: need at least 2 samples per bin</span>
            <span class="n">max_safe_bins</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_unique_targets</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">max_safe_bins</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too few samples (</span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">) or unique targets (</span><span class="si">{</span><span class="n">n_unique_targets</span><span class="si">}</span><span class="s2">) for quantile binning, using uniform strategy&quot;</span><span class="p">)</span>
                <span class="n">discretizer</span> <span class="o">=</span> <span class="n">KBinsDiscretizer</span><span class="p">(</span><span class="n">n_bins</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">encode</span><span class="o">=</span><span class="s1">&#39;ordinal&#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span>
                <span class="n">n_bins</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">discretizer</span> <span class="o">=</span> <span class="n">KBinsDiscretizer</span><span class="p">(</span><span class="n">n_bins</span><span class="o">=</span><span class="n">max_safe_bins</span><span class="p">,</span> <span class="n">encode</span><span class="o">=</span><span class="s1">&#39;ordinal&#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
                <span class="n">n_bins</span> <span class="o">=</span> <span class="n">max_safe_bins</span>
            
            <span class="n">y</span> <span class="o">=</span> <span class="n">discretizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binned continuous target into </span><span class="si">{</span><span class="n">n_bins</span><span class="si">}</span><span class="s2"> classes using </span><span class="si">{</span><span class="n">discretizer</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s2"> strategy&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">preserve_regression</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preserving continuous target for regression task (preserve_regression=True)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Clean NaN and inf values from dataset</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning NaN and inf values from dataset&quot;</span><span class="p">)</span>
        
        <span class="c1"># Clean target variable y</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
            <span class="n">before_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">mask_y</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">mask_y</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask_y</span><span class="p">]</span> 
            <span class="n">after_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">before_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">after_count</span><span class="si">}</span><span class="s2"> samples with NaN/inf in target variable&quot;</span><span class="p">)</span>
        
        <span class="c1"># Clean feature matrix X  </span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
            <span class="n">before_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">mask_X</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">mask_X</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask_X</span><span class="p">]</span>
            <span class="n">after_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> 
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">before_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">after_count</span><span class="si">}</span><span class="s2"> samples with NaN/inf in features&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final dataset size after cleaning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
        
        <span class="c1"># Log basic dataset information</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">num_categorical</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">categorical_indicator</span><span class="p">)</span> <span class="k">if</span> <span class="n">categorical_indicator</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="n">num_numerical</span> <span class="o">=</span> <span class="n">num_features</span> <span class="o">-</span> <span class="n">num_categorical</span> <span class="k">if</span> <span class="n">categorical_indicator</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset info: </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples, </span><span class="si">{</span><span class="n">num_features</span><span class="si">}</span><span class="s2"> features &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">num_categorical</span><span class="si">}</span><span class="s2"> categorical, </span><span class="si">{</span><span class="n">num_numerical</span><span class="si">}</span><span class="s2"> numerical), &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2"> classes&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if dataset has enough samples (minimum 1000)</span>
        <span class="k">if</span> <span class="n">num_samples</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bypass_size_check</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has only </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples, which is fewer than the minimum 1000 required, but bypassing size check.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has only </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples, which is fewer than the minimum 1000 required.&quot;</span><span class="p">)</span>
                <span class="c1"># Add to failed dataset cache</span>
                <span class="n">_FAILED_DATASET_CACHE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
                <span class="n">_save_failed_dataset_cache</span><span class="p">()</span>
                <span class="n">available_datasets</span> <span class="o">=</span> <span class="n">list_available_datasets</span><span class="p">()</span>
                <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                
                <span class="c1"># Provide a suggestion for alternative datasets</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Try one of these known working datasets instead:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="c1"># Pick 5 random datasets to suggest</span>
                    <span class="n">suggestions</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">available_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">did</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                        <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use list_available_datasets() to see all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> predefined datasets.&quot;</span>
                
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> has only </span><span class="si">{</span><span class="n">num_samples</span><span class="si">}</span><span class="s2"> samples (minimum 1000 required). </span><span class="si">{</span><span class="n">suggestion_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Register the successfully loaded dataset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="n">get_resource_manager</span><span class="p">()</span>
            
            <span class="c1"># Check if dataset is already registered</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">dataset_registry</span><span class="o">.</span><span class="n">find_dataset_by_name</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
                <span class="c1"># Resolve OpenML identifiers to get proper task_id</span>
                <span class="n">identifiers</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">resolve_openml_identifiers</span><span class="p">(</span><span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
                <span class="n">resolved_task_id</span> <span class="o">=</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">)</span>
                
                <span class="c1"># Create metadata for the dataset</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">DatasetMetadata</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;openml&#39;</span><span class="p">,</span>
                    <span class="n">openml_task_id</span><span class="o">=</span><span class="n">resolved_task_id</span><span class="p">,</span>  <span class="c1"># Use resolved task_id, not dataset_id</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">num_features</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">num_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
                    <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span> <span class="k">if</span> <span class="n">preserve_regression</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s1">&#39;classification&#39;</span>
                <span class="p">)</span>
                
                <span class="n">rm</span><span class="o">.</span><span class="n">dataset_registry</span><span class="o">.</span><span class="n">register_dataset</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered dataset </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in resource manager&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not register dataset in resource manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Add the failed dataset ID to the cache</span>
        <span class="n">_FAILED_DATASET_CACHE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">_save_failed_dataset_cache</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2"> to failed dataset cache&quot;</span><span class="p">)</span>
        
        <span class="n">available_datasets</span> <span class="o">=</span> <span class="n">list_available_datasets</span><span class="p">()</span>
        <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Provide a suggestion for alternative datasets</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">suggestion_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Try one of these known working datasets instead:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># Pick 5 random datasets to suggest</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">available_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">did</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">suggestion_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use list_available_datasets() to see all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">available_datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> predefined datasets.&quot;</span>
        
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset with ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">suggestion_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="clear_failed_dataset_cache">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.clear_failed_dataset_cache">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_failed_dataset_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the cache of failed dataset IDs.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_FAILED_DATASET_CACHE</span>
    <span class="n">_FAILED_DATASET_CACHE</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">_save_failed_dataset_cache</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared the failed dataset cache&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_failed_dataset_ids">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.get_failed_dataset_ids">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_failed_dataset_ids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the list of dataset IDs that have failed to load.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_FAILED_DATASET_CACHE</span><span class="p">)</span></div>



<div class="viewcode-block" id="analyze_dataset">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.analyze_dataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">analyze_dataset</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze the class distribution in the dataset splits.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        X_train: Training features</span>
<span class="sd">        y_train: Training labels</span>
<span class="sd">        X_val: Validation features</span>
<span class="sd">        y_val: Validation labels</span>
<span class="sd">        X_test: Test features</span>
<span class="sd">        y_test: Test labels</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        train_counts: Class distribution in training set</span>
<span class="sd">        val_counts: Class distribution in validation set</span>
<span class="sd">        test_counts: Class distribution in test set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing class distribution in dataset splits:&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get unique classes</span>
    <span class="n">all_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]))</span>
    
    <span class="c1"># Check train set</span>
    <span class="n">train_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">all_classes</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="n">train_counts</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
    
    <span class="c1"># Check val set</span>
    <span class="n">val_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">all_classes</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_val</span> <span class="o">==</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="n">val_counts</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
    
    <span class="c1"># Check test set</span>
    <span class="n">test_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">all_classes</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="n">test_counts</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train set class distribution: </span><span class="si">{</span><span class="n">train_counts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Val set class distribution: </span><span class="si">{</span><span class="n">val_counts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test set class distribution: </span><span class="si">{</span><span class="n">test_counts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">train_counts</span><span class="p">,</span> <span class="n">val_counts</span><span class="p">,</span> <span class="n">test_counts</span></div>



<div class="viewcode-block" id="create_llm_dataset">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.create_llm_dataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_llm_dataset</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">X_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">val_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">prefix_start_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">prefix_end_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">class_token_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_few_shot_examples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">max_train_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_test_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create LLM datasets with TabPFN embeddings as prefix.</span>

<span class="sd">    Args:</span>
<span class="sd">        X_train: Training features</span>
<span class="sd">        y_train: Training labels</span>
<span class="sd">        X_val: Validation features</span>
<span class="sd">        y_val: Validation labels</span>
<span class="sd">        X_test: Test features</span>
<span class="sd">        y_test: Test labels</span>
<span class="sd">        train_embeddings: TabPFN embeddings for training set</span>
<span class="sd">        val_embeddings: TabPFN embeddings for validation set</span>
<span class="sd">        test_embeddings: TabPFN embeddings for test set</span>
<span class="sd">        tokenizer: Tokenizer for the LLM</span>
<span class="sd">        prefix_start_id: Token ID for prefix start marker</span>
<span class="sd">        prefix_end_id: Token ID for prefix end marker</span>
<span class="sd">        class_token_ids: List of token IDs for class tokens</span>
<span class="sd">        output_dir: Directory to save prefix data</span>
<span class="sd">        num_few_shot_examples: Number of few-shot examples to include in the prefix</span>
<span class="sd">                              (configurable at inference time)</span>
<span class="sd">        max_train_samples: Maximum number of training samples to use (None for no limit)</span>
<span class="sd">        max_test_samples: Maximum number of test and validation samples to use (None for no limit)</span>

<span class="sd">    Returns:</span>
<span class="sd">        train_dataset: Training dataset</span>
<span class="sd">        eval_dataset: Evaluation dataset</span>
<span class="sd">        test_dataset: Test dataset</span>
<span class="sd">        label_encoder: Label encoder for class labels</span>
<span class="sd">        prefix_data_file: Path to the saved prefix data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating datasets for LLM training and evaluation&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ensure all label arrays are integers for classification</span>
    <span class="c1"># TabPFN and the LLM label encoding work expects discrete classes</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_integer_labels</span><span class="p">(</span><span class="n">y_array</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_array</span><span class="p">)</span>
        
        <span class="c1"># If label type is float but all values are integers, convert to int</span>
        <span class="k">if</span> <span class="n">y_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="n">unique_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_array</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">unique_vals</span><span class="p">[:</span><span class="mi">100</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting float labels to integers for LLM dataset&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">y_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Otherwise leave as is - the label encoder will handle it</span>
        <span class="k">return</span> <span class="n">y_array</span>

    <span class="c1"># Ensure all labels are in proper format</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">ensure_integer_labels</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_val</span> <span class="o">=</span> <span class="n">ensure_integer_labels</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">ensure_integer_labels</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>
    
    <span class="c1"># Check for continuous labels (rare case, should&#39;ve been binned earlier)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Detected float labels in dataset, will be encoded as distinct classes&quot;</span><span class="p">)</span>
    
    <span class="c1"># Encode labels to ensure consistency between TabPFN and LLM</span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error encoding labels: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Fall back approach if concatenation fails</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">y_arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]:</span>
            <span class="n">unique_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_arr</span><span class="p">))</span>
        <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Used fallback label encoding with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes&quot;</span><span class="p">)</span>
    
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_val_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>
    
    <span class="c1"># Log label encoding information</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique classes&quot;</span><span class="p">)</span>
    
    <span class="c1"># Verify we have enough class tokens</span>
    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_classes</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_token_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough class tokens for </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2"> classes (have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_token_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TabPFN embedding shapes - Train: </span><span class="si">{</span><span class="n">train_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Val: </span><span class="si">{</span><span class="n">val_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Test: </span><span class="si">{</span><span class="n">test_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Prepare prefix embeddings from train set with samples from all classes</span>
    <span class="c1"># This returns both embeddings and their corresponding labels</span>
    <span class="n">prefix_embeddings</span><span class="p">,</span> <span class="n">prefix_class_labels</span> <span class="o">=</span> <span class="n">prepare_tabpfn_embeddings_for_prefix</span><span class="p">(</span>
        <span class="n">train_embeddings</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">,</span> <span class="n">num_embeddings</span><span class="o">=</span><span class="n">num_few_shot_examples</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prepared prefix data - Embeddings: </span><span class="si">{</span><span class="n">prefix_embeddings</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Class labels: </span><span class="si">{</span><span class="n">prefix_class_labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Save prefix embeddings and class labels</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">prefix_data_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;prefix_data.npz&quot;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">prefix_data_file</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">=</span><span class="n">prefix_embeddings</span><span class="p">,</span> <span class="n">class_labels</span><span class="o">=</span><span class="n">prefix_class_labels</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved prefix data to </span><span class="si">{</span><span class="n">prefix_data_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check that length of embeddings and labels match</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_embeddings</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_val_encoded</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mismatch between embeddings and labels: val embeddings: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2">, val labels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_val_encoded</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;test embeddings: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2">, test labels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Trim the encoded label arrays to match the embedding lengths</span>
        <span class="n">val_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_embeddings</span><span class="p">)</span>
        <span class="n">test_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span>
        
        <span class="c1"># Ensure we don&#39;t try to access more elements than available</span>
        <span class="k">if</span> <span class="n">val_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_val_encoded</span><span class="p">):</span>
            <span class="n">val_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_val_encoded</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">test_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">):</span>
            <span class="n">test_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)</span>
            
        <span class="c1"># Use the trimmed lengths</span>
        <span class="n">y_val_encoded</span> <span class="o">=</span> <span class="n">y_val_encoded</span><span class="p">[:</span><span class="n">val_length</span><span class="p">]</span>
        <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">y_test_encoded</span><span class="p">[:</span><span class="n">test_length</span><span class="p">]</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aligned label and embedding counts: now using </span><span class="si">{</span><span class="n">val_length</span><span class="si">}</span><span class="s2"> validation samples and </span><span class="si">{</span><span class="n">test_length</span><span class="si">}</span><span class="s2"> test samples&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_embeddings</span><span class="p">)</span>
        <span class="n">test_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Apply max_test_samples limit to validation set if specified</span>
    <span class="k">if</span> <span class="n">max_test_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val_length</span> <span class="o">&gt;</span> <span class="n">max_test_samples</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limiting validation set from </span><span class="si">{</span><span class="n">val_length</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_test_samples</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
        <span class="n">val_length</span> <span class="o">=</span> <span class="n">max_test_samples</span>
    
    <span class="c1"># Apply max_test_samples limit to test set if specified</span>
    <span class="k">if</span> <span class="n">max_test_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">test_length</span> <span class="o">&gt;</span> <span class="n">max_test_samples</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limiting test set from </span><span class="si">{</span><span class="n">test_length</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_test_samples</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
        <span class="n">test_length</span> <span class="o">=</span> <span class="n">max_test_samples</span>
    
    <span class="c1"># Create validation examples for training</span>
    <span class="n">val_examples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_val_encoded</span><span class="p">)):</span>  <span class="c1"># Use the length of y_val_encoded directly</span>
        <span class="n">val_examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;label_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_val_encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>  <span class="c1"># Use numeric label ID instead of string</span>
            <span class="s2">&quot;query_embedding&quot;</span><span class="p">:</span> <span class="n">val_embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">})</span>
    
    <span class="c1"># Create test examples</span>
    <span class="n">test_examples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)):</span>  <span class="c1"># Use the length of y_test_encoded directly</span>
        <span class="n">test_examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;label_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="s2">&quot;query_embedding&quot;</span><span class="p">:</span> <span class="n">test_embeddings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">})</span>
    
    <span class="c1"># Split validation examples into train and eval</span>
    <span class="n">train_val_split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">val_examples</span><span class="p">))</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">val_examples</span><span class="p">[:</span><span class="n">train_val_split</span><span class="p">]</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">val_examples</span><span class="p">[</span><span class="n">train_val_split</span><span class="p">:]</span>
    
    <span class="c1"># Apply max_train_samples limit if specified</span>
    <span class="k">if</span> <span class="n">max_train_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_train_samples</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limiting training set from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">max_train_samples</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[:</span><span class="n">max_train_samples</span><span class="p">]</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created datasets - Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">, Eval: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">, Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_examples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Convert to Hugging Face datasets</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
        <span class="s2">&quot;label_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;label_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">train_dataset</span><span class="p">],</span>
        <span class="s2">&quot;query_embedding&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;query_embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">train_dataset</span><span class="p">]</span>
    <span class="p">})</span>
    
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
        <span class="s2">&quot;label_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;label_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">eval_dataset</span><span class="p">],</span>
        <span class="s2">&quot;query_embedding&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;query_embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">eval_dataset</span><span class="p">]</span>
    <span class="p">})</span>
    
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
        <span class="s2">&quot;label_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;label_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">test_examples</span><span class="p">],</span>
        <span class="s2">&quot;query_embedding&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;query_embedding&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">test_examples</span><span class="p">]</span>
    <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">label_encoder</span><span class="p">,</span> <span class="n">prefix_data_file</span></div>



<div class="viewcode-block" id="load_datasets">
<a class="viewcode-back" href="../../../api-reference/marvis.data.html#marvis.data.dataset.load_datasets">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_datasets</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load datasets based on command line arguments.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
    
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Clear the _FAILED_DATASET_CACHE to always try loading the dataset</span>
    <span class="n">clear_failed_dataset_cache</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared _FAILED_DATASET_CACHE to ensure dataset loading is attempted&quot;</span><span class="p">)</span>
    
    <span class="c1"># Case 1: Single dataset by name</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;dataset_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading single dataset: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">preserve_regression</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;preserve_regression&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">bypass_size_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_regression</span><span class="o">=</span><span class="n">preserve_regression</span><span class="p">)</span>
            <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
                <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                <span class="s2">&quot;categorical_indicator&quot;</span><span class="p">:</span> <span class="n">categorical_indicator</span><span class="p">,</span>
                <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="n">attribute_names</span>
            <span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded dataset </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Case 2: Multiple datasets by ID</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;dataset_ids&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_ids</span><span class="p">:</span>
        <span class="n">dataset_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading datasets with IDs: </span><span class="si">{</span><span class="n">dataset_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">preserve_regression</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;preserve_regression&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="n">dataset_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">bypass_size_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_regression</span><span class="o">=</span><span class="n">preserve_regression</span><span class="p">)</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">dataset_id</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
                    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;categorical_indicator&quot;</span><span class="p">:</span> <span class="n">categorical_indicator</span><span class="p">,</span>
                    <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="n">attribute_names</span>
                <span class="p">})</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded dataset </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="c1"># Case 2b: Multiple datasets by task ID</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;task_ids&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">task_ids</span><span class="p">:</span>
        <span class="n">task_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">task_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading datasets with task IDs: </span><span class="si">{</span><span class="n">task_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">preserve_regression</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;preserve_regression&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Get resource manager to resolve task IDs to dataset IDs</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">get_resource_manager</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">task_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Resolve task_id to dataset_id</span>
                <span class="n">identifiers</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">resolve_openml_identifiers</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">)</span>
                <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_id&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">dataset_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not resolve task ID </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> to dataset ID&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                    
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task ID </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> resolves to dataset ID </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">),</span> <span class="n">bypass_size_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_regression</span><span class="o">=</span><span class="n">preserve_regression</span><span class="p">)</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">dataset_id</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
                    <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span>  <span class="c1"># Include task_id in the dataset dict</span>
                    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;categorical_indicator&quot;</span><span class="p">:</span> <span class="n">categorical_indicator</span><span class="p">,</span>
                    <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="n">attribute_names</span>
                <span class="p">})</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded dataset </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Case 3: Load from directory of CSV files</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;data_dir&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">data_dir</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_csv_dataset</span>  <span class="c1"># Import here to avoid circular imports</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading datasets from directory: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">csv_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;*.csv&quot;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">csv_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No CSV files found in directory </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">csv_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> CSV files&quot;</span><span class="p">)</span>
        
        <span class="c1"># Filter to avoid double loading when we have separate X and y files</span>
        <span class="n">x_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">csv_files</span> <span class="k">if</span> <span class="s1">&#39;_X&#39;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s1">&#39;_x&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="n">y_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">csv_files</span> <span class="k">if</span> <span class="s1">&#39;_y&#39;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s1">&#39;_Y&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="n">non_xy_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">csv_files</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x_files</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">y_files</span><span class="p">]</span>
        
        <span class="c1"># Use X files if available, otherwise use regular CSV files</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">x_files</span> <span class="k">if</span> <span class="n">x_files</span> <span class="k">else</span> <span class="n">non_xy_files</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_to_process</span><span class="p">)</span><span class="si">}</span><span class="s2"> dataset files&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_process</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">load_csv_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
                    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                    <span class="s2">&quot;categorical_indicator&quot;</span><span class="p">:</span> <span class="n">categorical_indicator</span><span class="p">,</span>
                    <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="n">attribute_names</span><span class="p">,</span>
                    <span class="s2">&quot;is_csv&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">})</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded dataset </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Case 4: Sample random datasets from OpenML</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;num_datasets&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">num_datasets</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampling </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">num_datasets</span><span class="si">}</span><span class="s2"> random datasets from OpenML&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">openml</span>
            
            <span class="c1"># Use a curated list of known working datasets</span>
            <span class="n">benchmark_datasets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mi">1590</span><span class="p">,</span>   <span class="c1"># adult (binary)</span>
                <span class="mi">1461</span><span class="p">,</span>   <span class="c1"># bank-marketing (binary)</span>
                <span class="mi">40975</span><span class="p">,</span>  <span class="c1"># car (4 classes)</span>
                <span class="mi">31</span><span class="p">,</span>     <span class="c1"># credit-g (binary)</span>
                <span class="mi">37</span><span class="p">,</span>     <span class="c1"># diabetes (binary)</span>
                <span class="mi">54</span><span class="p">,</span>     <span class="c1"># vehicle (4 classes)</span>
                <span class="mi">1489</span><span class="p">,</span>   <span class="c1"># phoneme (binary)</span>
                <span class="mi">40498</span><span class="p">,</span>  <span class="c1"># wine-quality-white (7 classes)</span>
                <span class="mi">40701</span><span class="p">,</span>  <span class="c1"># australian (binary)</span>
                <span class="mi">40981</span><span class="p">,</span>  <span class="c1"># kr-vs-kp (binary)</span>
            <span class="p">]</span>
            
            <span class="c1"># Create a dedicated random generator with the specified seed</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span>
            
            <span class="c1"># Sample from benchmark datasets if we have enough</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">benchmark_datasets</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_datasets</span><span class="p">:</span>
                <span class="n">dataset_ids</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">benchmark_datasets</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_datasets</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampled </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> datasets from benchmark set&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset_ids</span> <span class="o">=</span> <span class="n">benchmark_datasets</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> benchmark datasets (less than requested </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">num_datasets</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            
            <span class="c1"># Now try to load each dataset</span>
            <span class="n">preserve_regression</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;preserve_regression&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="n">dataset_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">categorical_indicator</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">),</span> <span class="n">bypass_size_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_regression</span><span class="o">=</span><span class="n">preserve_regression</span><span class="p">)</span>
                    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">dataset_id</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset_name</span><span class="p">,</span>
                        <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                        <span class="s2">&quot;categorical_indicator&quot;</span><span class="p">:</span> <span class="n">categorical_indicator</span><span class="p">,</span>
                        <span class="s2">&quot;attribute_names&quot;</span><span class="p">:</span> <span class="n">attribute_names</span>
                    <span class="p">})</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded dataset </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OpenML package not found. Please install it with &#39;pip install openml&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> datasets&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datasets</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, MARVIS Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>